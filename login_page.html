<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Logg inn â€“ Studentkalender</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" href="index.css">
</head>
<body>
  <!-- Navigation bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">Studentkalender</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link active" href="index.html">Hjem</a></li>
          <li class="nav-item"><a class="nav-link" href="subscriptions.html">Mine organisasjoner</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- main -->
  <main class="auth-shell">
    <div class="card auth-card">
      <div class="card-header auth-card-header">
        <h1 class="h4 m-0" id="form-title">Logg inn</h1>
      </div>

      <div class="card-body">
        <!-- meldinger -->
        <div id="message" class="alert d-none" role="alert"></div>

        <!-- Login form -->
        <form id="login-form" novalidate>
          <div class="mb-3">
            <label for="login-email" class="form-label">E-post</label>
            <input type="email" class="form-control" id="login-email" placeholder="din@epost.no" required>
          </div>
          <div class="mb-3">
            <label for="login-password" class="form-label">Passord</label>
            <input type="password" class="form-control" id="login-password" placeholder="Passord" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">Logg inn</button>

          <p class="toggle-line">
            <span class="text-muted">Har du ikke konto?</span>
            <a class="link-like" id="show-signup">Opprett konto</a>
          </p>
        </form>

        <!-- Signup form -->
        <form id="signup-form" class="d-none" novalidate>
          <div class="mb-3">
            <label for="signup-email" class="form-label">E-post</label>
            <input type="email" class="form-control" id="signup-email" placeholder="din@epost.no" required>
          </div>
          <div class="mb-3">
            <label for="signup-password" class="form-label">Passord</label>
            <input type="password" class="form-control" id="signup-password" placeholder="Minst 6 tegn" minlength="6" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">Opprett konto</button>

          <p class="toggle-line">
            <span class="text-muted">Har du allerede konto?</span>
            <a class="link-like" id="show-login">Logg inn</a>
          </p>
        </form>
      </div>
    </div>
  </main>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import {
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const loginForm  = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const showSignup = document.getElementById('show-signup');
    const showLogin  = document.getElementById('show-login');
    const messageBox = document.getElementById('message');
    const formTitle  = document.getElementById('form-title');

    const show = el => el.classList.remove('d-none');
    const hide = el => el.classList.add('d-none');

    // Toggle forms
    showSignup?.addEventListener('click', () => {
      hide(loginForm); show(signupForm);
      formTitle.textContent = 'Opprett konto';
      messageBox.className = 'alert d-none'; messageBox.textContent = '';
    });
    showLogin?.addEventListener('click', () => {
      hide(signupForm); show(loginForm);
      formTitle.textContent = 'Logg inn';
      messageBox.className = 'alert d-none'; messageBox.textContent = '';
    });

    // Meldingshjelpere
    function showError(t){ messageBox.textContent=t; messageBox.className='alert alert-danger'; }
    function showSuccess(t){ messageBox.textContent=t; messageBox.className='alert alert-success'; }

    // Login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        const uid = cred.user.uid;
        const snap = await getDoc(doc(db, "users", uid));
        if (snap.exists() && snap.data().isAdmin) {
          window.location.href = "admin_index.html";
        } else {
          window.location.href = "index.html";
        }
      } catch (err) {
        showError("Kunne ikke logge inn: " + err.message);
      }
    });

    // Signup
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, "users", cred.user.uid), {
          email, isAdmin:false, subscribedTo:[]
        });
        showSuccess("Konto opprettet for: " + cred.user.email);
        signupForm.reset();
      } catch (err) {
        showError("Kunne ikke opprette konto: " + err.message);
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
